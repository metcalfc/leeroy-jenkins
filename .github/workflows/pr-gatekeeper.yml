name: PR Gatekeeper

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check author permissions
        id: check-author
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            console.log(`PR author: ${author}`);

            try {
              // Check if the author has write (push) access to the repository
              const { data: permissionLevel } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: author
              });

              const permission = permissionLevel.permission;
              console.log(`Author permission level: ${permission}`);

              // write, maintain, and admin all have write access
              const hasWriteAccess = ['write', 'maintain', 'admin'].includes(permission);

              core.setOutput('author', author);
              core.setOutput('permission', permission);
              core.setOutput('has_write_access', hasWriteAccess.toString());

              return hasWriteAccess;
            } catch (error) {
              // If we can't check permissions (e.g., first-time contributor), assume no access
              console.log(`Could not check permissions: ${error.message}`);
              core.setOutput('author', author);
              core.setOutput('permission', 'none');
              core.setOutput('has_write_access', 'false');
              return false;
            }

      - name: Check commits for Leeroy attestation
        id: check-attestation
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          echo "Checking commits from ${BASE_SHA:0:8} to ${HEAD_SHA:0:8}"

          total=0
          attested=0
          unattested_commits=""
          attested_commits=""

          for sha in $(git rev-list ${BASE_SHA}..${HEAD_SHA}); do
            ((total++)) || true
            short_sha="${sha:0:8}"
            subject=$(git log -1 --format="%s" ${sha})

            # Check commit message for Leeroy attestation (today version)
            # Look for "AI-Assisted: true" in the commit message body
            commit_body=$(git log -1 --format="%b" ${sha})

            if echo "${commit_body}" | grep -q "^AI-Assisted: true"; then
              ((attested++)) || true
              attested_commits="${attested_commits}${short_sha} ${subject}\n"
              echo "✅ ${short_sha}: Has Leeroy attestation"
            else
              unattested_commits="${unattested_commits}${short_sha} ${subject}\n"
              echo "❌ ${short_sha}: No Leeroy attestation"
            fi
          done

          echo "total=${total}" >> $GITHUB_OUTPUT
          echo "attested=${attested}" >> $GITHUB_OUTPUT

          # All commits must have attestation for full coverage
          if [[ ${total} -gt 0 && ${attested} -eq ${total} ]]; then
            echo "all_attested=true" >> $GITHUB_OUTPUT
          else
            echo "all_attested=false" >> $GITHUB_OUTPUT
          fi

          # At least some commits have attestation
          if [[ ${attested} -gt 0 ]]; then
            echo "has_attestation=true" >> $GITHUB_OUTPUT
          else
            echo "has_attestation=false" >> $GITHUB_OUTPUT
          fi

          # Store commit lists for the comment
          echo "attested_commits<<EOF" >> $GITHUB_OUTPUT
          echo -e "${attested_commits}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "unattested_commits<<EOF" >> $GITHUB_OUTPUT
          echo -e "${unattested_commits}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Evaluate PR status
        id: evaluate
        run: |
          has_write="${{ steps.check-author.outputs.has_write_access }}"
          has_attestation="${{ steps.check-attestation.outputs.has_attestation }}"
          all_attested="${{ steps.check-attestation.outputs.all_attested }}"

          echo "Author has write access: ${has_write}"
          echo "Has any attestation: ${has_attestation}"
          echo "All commits attested: ${all_attested}"

          # Determine if PR should pass
          # Pass if: author has write access OR any commits have attestation
          if [[ "${has_write}" == "true" ]]; then
            echo "status=approved" >> $GITHUB_OUTPUT
            echo "reason=trusted_contributor" >> $GITHUB_OUTPUT
            echo "✅ PR approved: Author is a trusted contributor with write access"
          elif [[ "${all_attested}" == "true" ]]; then
            echo "status=approved" >> $GITHUB_OUTPUT
            echo "reason=full_attestation" >> $GITHUB_OUTPUT
            echo "✅ PR approved: All commits have Leeroy AI attestation"
          elif [[ "${has_attestation}" == "true" ]]; then
            echo "status=approved" >> $GITHUB_OUTPUT
            echo "reason=partial_attestation" >> $GITHUB_OUTPUT
            echo "✅ PR approved: Some commits have Leeroy AI attestation"
          else
            echo "status=rejected" >> $GITHUB_OUTPUT
            echo "reason=no_attestation" >> $GITHUB_OUTPUT
            echo "❌ PR rejected: No write access and no Leeroy attestation"
          fi

          # Determine label
          if [[ "${has_write}" == "true" ]]; then
            echo "label=trusted-contributor" >> $GITHUB_OUTPUT
          elif [[ "${all_attested}" == "true" ]]; then
            echo "label=ai-assisted" >> $GITHUB_OUTPUT
          elif [[ "${has_attestation}" == "true" ]]; then
            echo "label=ai-assisted-partial" >> $GITHUB_OUTPUT
          else
            echo "label=no-attestation" >> $GITHUB_OUTPUT
          fi

      - name: Add labels
        uses: actions/github-script@v7
        with:
          script: |
            const label = '${{ steps.evaluate.outputs.label }}';

            // All possible labels this action manages
            const managedLabels = [
              'trusted-contributor',
              'ai-assisted',
              'ai-assisted-partial',
              'no-attestation'
            ];

            // Remove any existing managed labels first
            const existingLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const labelsToRemove = existingLabels.data
              .filter(l => managedLabels.includes(l.name))
              .map(l => l.name);

            for (const oldLabel of labelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: oldLabel
              }).catch(() => {}); // Ignore if label doesn't exist
            }

            // Add new label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

            console.log(`Applied label: ${label}`);

      - name: Post status comment
        uses: actions/github-script@v7
        with:
          script: |
            const author = '${{ steps.check-author.outputs.author }}';
            const permission = '${{ steps.check-author.outputs.permission }}';
            const hasWriteAccess = '${{ steps.check-author.outputs.has_write_access }}' === 'true';
            const status = '${{ steps.evaluate.outputs.status }}';
            const reason = '${{ steps.evaluate.outputs.reason }}';
            const total = parseInt('${{ steps.check-attestation.outputs.total }}') || 0;
            const attested = parseInt('${{ steps.check-attestation.outputs.attested }}') || 0;
            const attestedCommits = `${{ steps.check-attestation.outputs.attested_commits }}`.trim();
            const unattestedCommits = `${{ steps.check-attestation.outputs.unattested_commits }}`.trim();

            const isApproved = status === 'approved';
            const icon = isApproved ? '✅' : '❌';
            const title = isApproved ? 'PR Approved' : 'PR Requires Attention';

            let body = `## ${icon} PR Gatekeeper: ${title}\n\n`;

            // Author info
            body += `### Contributor Status\n`;
            body += `- **Author:** @${author}\n`;
            body += `- **Permission Level:** ${permission}\n`;
            body += `- **Write Access:** ${hasWriteAccess ? '✅ Yes' : '❌ No'}\n\n`;

            // Attestation info
            body += `### AI Attestation Status\n`;
            body += `- **Commits with Leeroy attestation:** ${attested}/${total}\n\n`;

            if (attestedCommits) {
              body += `**Attested commits:**\n`;
              attestedCommits.split('\n').filter(Boolean).forEach(c => {
                body += `- ✅ \`${c}\`\n`;
              });
              body += '\n';
            }

            if (unattestedCommits) {
              body += `**Commits without attestation:**\n`;
              unattestedCommits.split('\n').filter(Boolean).forEach(c => {
                body += `- ❌ \`${c}\`\n`;
              });
              body += '\n';
            }

            // Decision explanation
            body += `### Decision\n`;
            switch (reason) {
              case 'trusted_contributor':
                body += `✅ **Approved:** @${author} is a trusted contributor with write access to this repository.\n`;
                break;
              case 'full_attestation':
                body += `✅ **Approved:** All commits include Leeroy AI attestation, providing full transparency about AI assistance.\n`;
                break;
              case 'partial_attestation':
                body += `✅ **Approved:** Some commits include Leeroy AI attestation. `;
                body += `Consider adding attestation to all commits for complete transparency.\n`;
                break;
              case 'no_attestation':
                body += `❌ **Rejected:** Author does not have write access and no commits include Leeroy AI attestation.\n\n`;
                body += `**To fix:**\n`;
                body += `1. Install [Leeroy](https://github.com/metcalfc/leeroy-jenkins) to add AI attestation to your commits, OR\n`;
                body += `2. Request write access to this repository\n`;
                break;
            }

            body += `\n---\n*This check is powered by [Leeroy Toolkit](https://github.com/metcalfc/leeroy-jenkins) - transparent attribution for AI-assisted code.*`;

            // Find and update existing comment or create new one
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('PR Gatekeeper')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if rejected
        if: steps.evaluate.outputs.status == 'rejected'
        run: |
          echo "::error::PR rejected: ${{ steps.evaluate.outputs.reason }}"
          echo ""
          echo "This PR was rejected because:"
          echo "  - Author does not have write access to this repository"
          echo "  - No commits include Leeroy AI attestation"
          echo ""
          echo "To resolve this:"
          echo "  1. Install Leeroy (https://github.com/metcalfc/leeroy-jenkins)"
          echo "  2. Recommit with AI attestation enabled"
          echo "  - OR request write access from repository maintainers"
          exit 1
