#!/usr/bin/env bash
#
# Leeroy - Git prepare-commit-msg Hook
# Embeds AI attestation directly into the commit message

set -euo pipefail

readonly COMMIT_MSG_FILE="$1"
readonly COMMIT_SOURCE="${2:-}"  # message, template, merge, squash, or commit
readonly SESSION_TRACKER="${HOME}/.leeroy/hooks/session-tracker.sh"

# Skip for merge commits and amends
[[ "${COMMIT_SOURCE}" == "merge" || "${COMMIT_SOURCE}" == "commit" ]] && exit 0

# Check session tracker exists
[[ ! -x "${SESSION_TRACKER}" ]] && exit 0

# Get session data
session_data=$("${SESSION_TRACKER}" get)
[[ "${session_data}" == "{}" ]] && exit 0

# Check if there's content to attest
files_count=$(echo "${session_data}" | jq '.files_modified | length')
prompts_count=$(echo "${session_data}" | jq '.prompts | length')
[[ "${files_count}" -eq 0 && "${prompts_count}" -eq 0 ]] && exit 0

# Format attestation block
format_attestation() {
    local data="$1"

    echo ""
    echo "---"
    echo "AI-Assisted: true"
    echo "AI-Tool: $(echo "${data}" | jq -r '.tool // "unknown"')/$(echo "${data}" | jq -r '.tool_version // "unknown"')"
    echo "AI-Model: $(echo "${data}" | jq -r '.model // "unknown"')"
    echo "AI-Session: $(echo "${data}" | jq -r '.session_id')"
    echo "AI-Started: $(echo "${data}" | jq -r '.started_at')"

    # List files (compact format)
    if [[ "${files_count}" -gt 0 ]]; then
        local files_list
        files_list=$(echo "${data}" | jq -r '.files_modified[].path' | tr '\n' ',' | sed 's/,$//')
        echo "AI-Files: ${files_list}"
    fi

    # Include prompts with timestamps
    if [[ "${prompts_count}" -gt 0 ]]; then
        echo ""
        echo "AI-Prompts:"
        echo "${data}" | jq -r '.prompts[] | "- [\(.timestamp | split("T")[1] | split("Z")[0])] \(.text)"'
    fi
}

# Append attestation to commit message
attestation=$(format_attestation "${session_data}")
existing_msg=$(cat "${COMMIT_MSG_FILE}")

echo "${existing_msg}" > "${COMMIT_MSG_FILE}"
echo "${attestation}" >> "${COMMIT_MSG_FILE}"

echo "Added AI attestation to commit message" >&2
